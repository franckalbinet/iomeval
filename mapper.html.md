# Mapper


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

Maps evaluation reports to IOMâ€™s SRF(Strategic Results Framework) and
GCM (Global Compact for Migration UN General Assembly resolution) themes
using LLM-based scoring. The module analyzes reports against four theme
hierarchies (SRF Enablers, Cross-cutting Priorities, GCM Objectives, and
SRF Outputs) using prompt caching for efficiency. Returns structured
centrality scores with reasoning and confidence levels for each theme.

## Response Models

[`ThemeScore`](https://franckalbinet.github.io/iomeval/mapper.html#themescore)
and
[`ThemeScores`](https://franckalbinet.github.io/iomeval/mapper.html#themescores)
are Pydantic models for structured LLM output. The LLM returns scores
for each theme with reasoning and confidence levels.

------------------------------------------------------------------------

<a
href="https://github.com/franckalbinet/iomeval/blob/main/iomeval/mapper.py#L18"
target="_blank" style="float:right; font-size:smaller">source</a>

### ThemeScore

>  ThemeScore (theme_id:str, theme_title:str, centrality_score:float,
>                  reasoning:str, confidence:str)

*Single themeâ€™s centrality assessment with score, reasoning, and
confidence*

------------------------------------------------------------------------

<a
href="https://github.com/franckalbinet/iomeval/blob/main/iomeval/mapper.py#L27"
target="_blank" style="float:right; font-size:smaller">source</a>

### ThemeScores

>  ThemeScores (scores:list[__main__.ThemeScore])

*Collection of theme centrality scores from a single mapping operation*

## Parsing

Helper functions to extract and sort results from the LLM response.

------------------------------------------------------------------------

<a
href="https://github.com/franckalbinet/iomeval/blob/main/iomeval/mapper.py#L32"
target="_blank" style="float:right; font-size:smaller">source</a>

### parse_json_response

>  parse_json_response (res)

*Extract and parse JSON content from LLM completion response*

------------------------------------------------------------------------

<a
href="https://github.com/franckalbinet/iomeval/blob/main/iomeval/mapper.py#L37"
target="_blank" style="float:right; font-size:smaller">source</a>

### sort_by_centrality

>  sort_by_centrality (res)

*Sort themes by centrality score, accepts raw response or parsed dict*

------------------------------------------------------------------------

<a
href="https://github.com/franckalbinet/iomeval/blob/main/iomeval/mapper.py#L43"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_top_ids

>  get_top_ids (res, min_score=0.7)

*Get IDs of themes with centrality score \>= min_score, accepts raw
response or parsed dict*

## Core Mapping

The core mapping functions prepare the report for caching and call the
LLM to score themes against the report content.

------------------------------------------------------------------------

<a
href="https://github.com/franckalbinet/iomeval/blob/main/iomeval/mapper.py#L49"
target="_blank" style="float:right; font-size:smaller">source</a>

### mk_system_blocks

>  mk_system_blocks (report:str)

*Create cached system message blocks from report text*

<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 38%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>report</td>
<td>str</td>
<td>Full report text to analyze</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>list</strong></td>
<td><strong>Anthropic-style content blocks with cache
control</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/franckalbinet/iomeval/blob/main/iomeval/mapper.py#L55"
target="_blank" style="float:right; font-size:smaller">source</a>

### map_themes

>  map_themes (system_blocks:list, themes:str, prompt:str,
>                  model:str='claude-haiku-4-5', response_format=<class
>                  '__main__.ThemeScores'>)

*Map report against themes using cached system blocks*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>system_blocks</td>
<td>list</td>
<td></td>
<td>Cached system blocks from mk_system_blocks</td>
</tr>
<tr>
<td>themes</td>
<td>str</td>
<td></td>
<td>Formatted themes text to score against</td>
</tr>
<tr>
<td>prompt</td>
<td>str</td>
<td></td>
<td>Mapping instruction prompt</td>
</tr>
<tr>
<td>model</td>
<td>str</td>
<td>claude-haiku-4-5</td>
<td>Model to use for completion</td>
</tr>
<tr>
<td>response_format</td>
<td>ModelMetaclass</td>
<td>ThemeScores</td>
<td>Pydantic model for structured output</td>
</tr>
</tbody>
</table>

``` python
from iomeval.extract import extract_sections
from mistocr.core import read_pgs

md = read_pgs('files/test/AAP%20Evaluation%20Report_final_')
report = extract_sections(md)
```

``` python
n_tokens(report)
```

    8657

``` python
system_blocks = mk_system_blocks(report)
print(system_blocks[0]['text'][:200])
```

    ## Report to Analyze

    ## EXECUTIVE SUMMARY  ... page 6

    This external evaluation assessed whether or not IOM is delivering on its commitments to accountability to affected populations (AAP), ${ }^{1}$

``` python
enablers = load_enablers()
prompt = load_prompt('srf_enablers')
res = map_themes(system_blocks, fmt_enablers_ccp(enablers), prompt)
sort_by_centrality(res)[:3]
```

    [{'theme_id': 'Cross-cutting 3',
      'theme_title': 'Funding',
      'centrality_score': 0.81,
      'reasoning': "Funding is a MAJOR COMPONENT throughout the evaluation. Executive Summary states 'Resources allocated to central AAP functions remain inadequate' and notes 'AAP Coordination Unit is largely funded with earmarked funds.' Conclusions emphasize inadequate resource allocation repeatedly: 'The opinion that resources allocated to AAP in IOM are inadequate was prevalent in both qualitative and quantitative data.' Recommendations 2, 4, and 5 directly address funding strategy and mechanisms (e.g., 'three-year plan connected to a funding strategy'; 'Establish a fund for supporting select country offices'). The Ethiopia case study exemplifies office-wide funding approach. Multiple findings address unsustainability risks from fragmented, project-specific funding models.",
      'confidence': 'high'},
     {'theme_id': 'Cross-cutting 4',
      'theme_title': 'Data and evidence',
      'centrality_score': 0.75,
      'reasoning': "Data and evidence is a MAJOR COMPONENT, particularly regarding CFMs and feedback utilization. The evaluation identifies gaps: 'lack of technical resources and support to make full use of data gathered from affected people' (Executive Summary); Conclusions note 'need to structure or strengthen the processes that translate feedback into meaningful operational adjustments' and 'some informants perceived that not all data gathered from affected people were being used.' Recommendation 8 extensively addresses CFM system mapping, data standardization, and analysis ('CFM data analysis dashboards'). However, the evaluation does not address IOM's broader data for foresight, anticipatory action, or data as central to organizational decision-making.",
      'confidence': 'high'},
     {'theme_id': 'Cross-cutting 5',
      'theme_title': 'Learning and Innovation',
      'centrality_score': 0.68,
      'reasoning': "Learning and innovation is a SIGNIFICANT/MAJOR element. Executive Summary identifies demand for 'learning and to proactively support IOM country offices.' Recommendation 7 addresses 'training opportunities and update capacity-building material with increased focus on practical AAP implementation,' with emphasis on knowledge sharing through 'communities of practice.' Recommendation 6 focuses on visibility and knowledge management for AAP good practices. Case studies document 'innovative' AAP approaches (e.g., IOM TÃ¼rkiye's cross-border operations). However, the evaluation does not systematically address innovation as organizational capability, technology use, private sector collaboration, or learning as internal decision-making processes beyond AAP domain.",
      'confidence': 'high'}]

## Pipeline

The full pipeline maps a report against all theme hierarchies: SRF
Enablers â†’ Cross-cutting Priorities â†’ GCM Objectives â†’ SRF Outputs. The
GCM lookup table filters which outputs to score based on top GCM
objectives.

------------------------------------------------------------------------

<a
href="https://github.com/franckalbinet/iomeval/blob/main/iomeval/mapper.py#L66"
target="_blank" style="float:right; font-size:smaller">source</a>

### load_prompts

>  load_prompts (path:str='files/prompts')

*Load all mapping prompts*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>path</td>
<td>str</td>
<td>files/prompts</td>
<td>Directory containing prompt files</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>AttrDict</strong></td>
<td></td>
<td><strong>Dict with srf_enablers, srf_ccps, gcm, srf_outputs
prompts</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/franckalbinet/iomeval/blob/main/iomeval/mapper.py#L73"
target="_blank" style="float:right; font-size:smaller">source</a>

### map_all

>  map_all (report:str, path:str='files/themes',
>               prompt_path:str='files/prompts', verbose:bool=True,
>               model:str='claude-haiku-4-5', response_format=<class
>               '__main__.ThemeScores'>)

*Map report against all theme classes: enablers â†’ CCP â†’ GCM â†’ outputs*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>report</td>
<td>str</td>
<td></td>
<td>Full report text to analyze</td>
</tr>
<tr>
<td>path</td>
<td>str</td>
<td>files/themes</td>
<td>Directory containing theme JSON files</td>
</tr>
<tr>
<td>prompt_path</td>
<td>str</td>
<td>files/prompts</td>
<td>Directory containing prompt files</td>
</tr>
<tr>
<td>verbose</td>
<td>bool</td>
<td>True</td>
<td>Print progress messages</td>
</tr>
<tr>
<td>model</td>
<td>str</td>
<td>claude-haiku-4-5</td>
<td>Model to use for completion</td>
</tr>
<tr>
<td>response_format</td>
<td>ModelMetaclass</td>
<td>ThemeScores</td>
<td>Pydantic model for structured output</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>AttrDict</strong></td>
<td></td>
<td><strong>Dict with enablers, ccp, gcm, outputs results</strong></td>
</tr>
</tbody>
</table>

``` python
res = map_all(report)
```

    Mapping SRF Enablers...
    Mapping Cross-cutting Priorities...
    Mapping GCM Objectives...
    Top GCM: 7 (from 2 candidates)
    Mapping 26 filtered SRF Outputs...

``` python
sort_by_centrality(res.enablers)[:2]
```

    [{'theme_id': 'Cross-cutting 3',
      'theme_title': 'Funding',
      'centrality_score': 0.82,
      'reasoning': "Funding is a PRIMARY FOCUS. The evaluation identifies inadequate resource allocation as a central finding, appearing prominently in the Executive Summary: 'Resources allocated to central AAP functions remain inadequate.' Funding is addressed extensively across multiple sections: the AAP Coordination Unit lacks core funding and relies on 'earmarked funds'; country-level AAP is 'project-specific' creating fragmentation; there is 'no strategic approach to AAP funding' (Conclusions). Recommendations 2, 4, and 5 all directly address funding strategy and mechanisms. However, broader financing innovation, multi-year programming, and flexible fundingâ€”elements of the enabler descriptionâ€”are not explored, limiting it from 0.9.",
      'confidence': 'high'},
     {'theme_id': 'Cross-cutting 2',
      'theme_title': 'Partnership',
      'centrality_score': 0.68,
      'reasoning': "Partnership is a major component of the AAP Framework itself. The evaluation emphasizes 'inter-agency AAP coordination spaces' and 'collective accountability' as critical themes (Conclusions section). Recommendation 9 explicitly addresses 'collaboration and engagement on collective accountability' and participation in IASC structures. The case studies reference partnerships with government and civil society. However, partnership development for broader IOM programming, equitable partnerships with national actors, and whole-of-society solutions receive limited analysis. Partnerships are discussed primarily within the narrow context of AAP coordination rather than as a strategic organizational capability.",
      'confidence': 'high'}]

``` python
sort_by_centrality(res.ccp)[:2]
```

    [{'theme_id': 'Cross-cutting 1',
      'theme_title': 'Integrity, Transparency and Accountability',
      'centrality_score': 0.95,
      'reasoning': "This is a THEMATIC EVALUATION of AAP, which directly operationalizes accountability to affected populations. The entire evaluation assesses IOM's commitment to 'active commitment to use power responsibly by taking account of, giving account to, and being held to account by the people' (Executive Summary). Accountability appears in evaluation objectives, findings on 'collective accountability' (Conclusions), CFM mechanisms (Recommendation 8), and visibility/transparency (Recommendation 6). The evaluation systematically assesses accountability structures, transparency of feedback mechanisms, and institutional commitment to these principles across multiple sections and recommendations.",
      'confidence': 'high'},
     {'theme_id': 'Cross-cutting 3',
      'theme_title': 'Protection-centred',
      'centrality_score': 0.72,
      'reasoning': "Protection is a MAJOR COMPONENT of this AAP-focused evaluation. Findings reference 'protection risks and needs of vulnerable populations' (Conclusions); the AAP Framework itself centers on rights-based approaches and placing affected populations' well-being in decision-making, aligning with Protection-centred priorities. CFM mechanisms (Recommendation 8) and participation structures (throughout) are protection-related accountability tools. PSEAH is mentioned in background documents (IN/234). However, dedicated assessment of child safeguarding, PSEAH mechanisms, or specific protection outcomes is limited. Protection underpins AAP's logic but is not independently evaluated.",
      'confidence': 'medium'}]

``` python
get_top_ids(res.gcm)
```

    ['7', '23']

``` python
sort_by_centrality(res.outputs)[:1]
```

    [{'theme_id': '3d31',
      'theme_title': 'Government and civil society stakeholders have improved knowledge, skills and resources to protect the rights of vulnerable migrants, including children and victims of trafficking, and are equipped to apply a survivor-centered, gender-sensitive, human-rights based approach.',
      'centrality_score': 0.75,
      'reasoning': "Directly relevant to AAP's human rights and vulnerable group protection focus. Report emphasizes AAP's grounding in human rights-based approaches (Conclusions, page 34: 'The desk review and consultations held confirmed that the IOM AAP approach considers the cross-cutting issues of human rights, gender equality and disability'). Findings address capacity gaps (Recommendations 4, 7 on training/support). However, evaluation does not assess actual vulnerable migrant protection outcomes or survivor-centered service deliveryâ€”focuses on organizational support capacity.",
      'confidence': 'high'}]

Can you provide a title and a short description for this module?

##### ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c -->

Based on the code, hereâ€™s a title and description:

**Title:** Theme Mapper

**Description:** Maps evaluation reports to IOMâ€™s Strategic Results
Framework themes using LLM-based scoring. The module analyzes reports
against four theme hierarchies (SRF Enablers, Cross-cutting Priorities,
GCM Objectives, and SRF Outputs) using prompt caching for efficiency.
Returns structured centrality scores with reasoning and confidence
levels for each theme.
